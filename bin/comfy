#!/usr/bin/env ruby
require 'comfy'
require 'fileutils'
require 'syslogger'
require 'settings'

# exit codes
DEFAULT_EXIT_CODE = 0
# OPTION_PARSING_ERROR_EXIT_CODE = 1 declared in Comfy::Opts
JSON_SCHEMA_VALIDATION_ERROR_EXIT_CODE = 2
PACKER_VALIDATION_ERROR_EXIT_CODE = 3
PACKER_EXECUTION_ERROR_EXIT_CODE = 4
INVALID_DISTRIBUTION_VERSION_ERROR_EXIT_CODE = 5
NO_SUCH_DISTRIBUTION_VERSION_ERROR_EXIT_CODE = 6

# Logger initialization
logger = Logger.new(STDOUT)

# make sure log file is specified while logging to file
if Settings['logging'] && Settings.logging['log_type'] == 'file' &&
  !Settings.logging['log_file']
  fail ArgumentError, 'Missing file for logging. Check your configuration file.'
end

# initialize specific logger according to the configuration
if Settings['logging'] && Settings['logging']['log_type'] == 'file'
  begin
    log_file = File.open(Settings['logging']['log_file'], File::WRONLY | File::CREAT | File::APPEND)
    logger = Logger.new(log_file)
  rescue => e
    puts "Unable to create log file #{Settings['logging']['log_file']}: #{e.message}.\
    Falling back to STDOUT."
  end
elsif Settings['logging'] && Settings['logging']['log_type'] == 'syslog'
  logger = Syslogger.new('comfy')
end

if Settings['logging'] && Settings.logging['log_level'] && Logger::Severity.const_defined?(Settings.logging['log_level'])
  logger.level = Logger::Severity.const_get Settings.logging['log_level']
else
  logger.level = Logger::ERROR
end

# Command line options handling
options = Comfy::Opts.parse(ARGV, logger)

opts = {}
opts[:size] = options.size
opts[:builders] = options.formats
opts[:distribution] = options.distribution
opts[:headless] = !options.debug
opts[:template_dir] = options.template_dir
opts[:version] = options.version
opts[:output_dir] = Settings['output_dir']

if options.debug
  logger.level = Logger::DEBUG
  ENV['PACKER_LOG'] = '1'
end

logger.debug("Starting Comfy with options: #{opts}.")

begin
  creator = Comfy::Creator.new(opts, logger)
  creator.create
rescue Comfy::Errors::PackerExecutionError
  logger.error($!.message)
  exit(PACKER_EXECUTION_ERROR_EXIT_CODE)
rescue Comfy::Errors::PackerValidationError
  logger.error($!.message)
  exit(PACKER_VALIDATION_ERROR_EXIT_CODE)
rescue Comfy::Errors::InvalidDistributionVersionError
  logger.error($!.message)
  exit(INVALID_DISTRIBUTION_VERSION_ERROR_EXIT_CODE)
rescue Comfy::Errors::NoSuchDistributionVersionError
  logger.error($!.message)
  exit(NO_SUCH_DISTRIBUTION_VERSION_ERROR_EXIT_CODE)
rescue JSON::Schema::ValidationError
  logger.error($!.message)
  exit(JSON_SCHEMA_VALIDATION_ERROR_EXIT_CODE)
ensure
  creator.clean()
end
