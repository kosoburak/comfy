#!/usr/bin/env ruby
require 'comfy'
require 'fileutils'
require 'syslogger'
require 'settings'

#Command line options handling
options = Comfy::Opts.parse(ARGV)

#Logger initialization
logger = Logger.new(STDOUT)

#initialize specific logger according to the configuration
if Settings['logging'] && Settings['logging']['log_type'] == 'file'
  begin
    log_file = File.open(Settings['logging']['log_file'], File::WRONLY | File::CREAT | File::APPEND)
    logger = Logger.new(log_file)
  rescue => e
    puts "Unable to create log file #{Settings['logging']['log_file']}: #{e.message}.\
Falling back to STDOUT."
  end
elsif Settings['logging'] && Settings['logging']['log_type'] == 'syslog'
  logger = Syslogger.new('comfy')
end

if Settings['logging'] && Settings.logging['log_level'] && Logger::Severity.const_defined?(Settings.logging['log_level'])
  logger.level = Logger::Severity.const_get Settings.logging['log_level']
else
  logger.level = Logger::ERROR
end

opts = {}
opts[:size] = options.size
opts[:format] = options.format
opts[:distros] = options.distros
opts[:params] = options.params

logger.debug("Starting Comfy with options: #{opts}.")

creator = Comfy::Creator.new(opts, logger)
creator.create


